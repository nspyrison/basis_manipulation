---
title: "spinifex Vignette"
author: "Nicholas Spyrison"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette  
#EXAMPLE: https://github.com/njtierney/naniar/blob/master/vignettes/getting-started-w-naniar.Rmd
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# Overview

Datasets commonly contain many (p>3) variables/dimensions. Numeric aggregation and modeling is scalable as the number of dimensions increase. Visualization of model and estimate-space (think residual or parallel coordinate plots) scale relatively well with dimension. Yet, visuals in data-space often fall by the wayside, especially when trying to illustrate more than 3 dimensions. If not all together abandanded, suboptimal techniques are commonly employed.

Traditionally, component analysis (PCA), correspondence analysis (CCA), or other single value decomposistion (SVD) techniques have been used to approximate high dim spaces in 2 or 3-d. However doing so requires the loss of information of the discarded, transformed dimensions.

More recently stochastic neighbor embedding (t-SNE), Sammon mapping, and other non-linear transformations have seen a rise in popularity. These techniques can make astounding graphs showing distinctions and likeness across groups, but can suffer from over-fitting (potentially resulting in flase groupings) and lose interprebility back to the original dimensions.

The R package tourr [@Cook&Wickham] provides open source tools for exploring high dim spaces that doesn't lose information and maintains dimension-interprebility. Orthonormal linear combinations of p-dimensions can be projected onto a 2-d surface and viewed as a xy scatter plot for instance. By changing the (constrained) linear combinations slightly, the 2-d projection changes in time as data are rotated in p-dimensions. Randomly selecting a dimension and direction of change is essentially the projection-pursuit method, "grand tour", orginally purposed by Asimov [@Asimov et. al. 1985]. Other tours and gradient-descent indexs are discussed in the tourr package documentation hosted on CRAN, [here](https://cran.r-project.org/web/packages/tourr/tourr.pdf).

This concept can be illustrated susinctly by example. A 3-d object blocks a light source that casts a shadow onto a screen. If the object is a four-legged chair some orientations look like a black square, this conveys  little information about the shape of the object. However if the chair is rotated side or front view is seen. With continued rotation the 3-d shape can be distinguished from a 2-d animation. In the same way, information and interesting profiles describing high dimensional data can be found by watching projections of the data as it rotates.





# Example 1 - Rotate Flea data

Suppose we want to perform a rotation on one (or more) dimensions on the projection of a higher dimensional (p>3-d) space/data. 

Let: 

- n be number of observations (rows)
- p be number of dimensions/numeric variables (columns)
- d be the number of dimensions in variable space. Each dimension is a linear combinations of the variables. For our purposes each basis will be d=2 (which will go to d=3 to rotate the linear combinations out of plane). 

In order to rotate a dimension in p-space we need the following args: 

- `basis`, a starting basis, an orthonormal linear combination of p-dimensions, 
- `manip_var`, which dimension(s) to rotate,
- `phi`, angle controlling the magnitude of change of `manip var`
- `theta`, the angle of the change of the `manip var`

For a test data set use flea [n=74, p=6]. In order to get to a manipulation space (`manip_space`) use `create_manip_space(basis, manip_var)`. Below, we will generate a random basis [p, d=2] via `basis_random(p)` and arbitrarily let the `manip_var` be 3.

```{r}
#devtools::install_github("nspyrison/spinifex")
library(spinifex)

data <- flea[, 1:6]
p <- ncol(data)
b_rand <- basis_random(p = p)
```

We then rotate the 3rd variable by an arbitrarily desired magnitude, `phi`, at an arbitrarily desired magnitude, `theta`. The [p, d+1=3] rotated space, (`r_space`) is returned. This is the the linear combination for the xyz contributions in p-space for this rotation.

```{r}
dp <-
  data_proj(
    data = data,
    basis = b_rand,
    manip_var = 3,
    manip = "radial",
    from = 0,
    to = pi
  )
#slideshow(dp, col = flea[,7])
```

For illustration plot the projection of the data onto this new `r_space` and plot the xy contributions. Do this several times while varying the magnitude of of `phi` an angle controlling the magnitude of manipulation of the `manip_var`. At a constant `theta` angle of rotation in coordinate space.



# Example 2 - Climate glyph map


```{r}
#library(GGally)
nasa <- nasa[nasa$date >= as.POSIXct("1998-01-01") &
               nasa$lat >= 20 &
               nasa$lat <= 40 &
               nasa$long >= -80 &
               nasa$long <= -60
             , ]
#str(nasa) #1:6 demographic, 7:13 var, 14:17 demographic
#dim(table(nasa$day)) #grain: month. 36 obs, 3 years
#head(nasa[, 7:15]) #12 is surftemp, 15 is day
```


```{r}
temp.gly <-
  GGally::glyphs(nasa, "long", "day", "lat", "surftemp", height = 2.5)
g1 <-
  ggplot2::ggplot(temp.gly, ggplot2::aes(gx, gy, group = gid)) +
  GGally::add_ref_lines(temp.gly, color = "grey90") +
  GGally::add_ref_boxes(temp.gly, color = "grey90") +
  ggplot2::geom_path() +
  ggplot2::theme_bw() +
  ggplot2::labs(x = "", y = "")
```


```{r}
## Do a horizontal rotation on day, changing a_2.
tmp <- nasa[, c(15, 7:11)] #exclude surftemp, temp
p <- ncol(tmp)
b_iden <- basis_identity(p = p)
dp_day <-
  data_proj(
    data = tmp,
    basis = b_iden,
    manip_var = "day",
    manip = "horizontal",
    from = 0,
    to = 1.48
  )
#slideshow(dp_day)
```


```{r}
## Do a vertical rotation on surftemp, changing b_2.
tmp <- nasa[, c(12, 7:11)] #exclude day, temp
p <- ncol(tmp)
b_iden <- basis_identity(p = p)
dp_surftemp <-
  data_proj(
    data = tmp,
    basis = b_iden,
    manip_var = "surftemp",
    manip = "vertical",
    from = 0,
    to = 1.88
  )
#slideshow(dp_surftemp)
```


```{r}
#library(dplyr)
nasa2 <- cbind(
  dplyr::select(nasa, c("long", "day", "lat", "surftemp")),
  adj_day = dplyr::filter(as.data.frame(dp_day), index == max(index))[, 1], #x_day
  adj_surftemp = dplyr::filter(as.data.frame(dp_surftemp), index == max(index))[, 2] #y_surftemp
)
#head(nasa2)
```

```{r}
temp.gly <-
  GGally::glyphs(nasa2, "long", "adj_day", "lat", "adj_surftemp", height = 2.5)
g2 <-
  ggplot2::ggplot(temp.gly, ggplot2::aes(gx, gy, group = gid)) +
  GGally::add_ref_lines(temp.gly, color = "grey90") +
  GGally::add_ref_boxes(temp.gly, color = "grey90") +
  ggplot2::geom_path() +
  ggplot2::theme_bw() +
  ggplot2::labs(x = "", y = "")

gridExtra::grid.arrange(g1, g2, ncol=2)
```


# Example 3 - Tour manipulation

```{r}
#library(tourr)
data <- flea[, 1:6]
p <- ncol(data)

holes_tour <- ## holes is unsupervised gradient descent.
  tourr::save_history(data, tourr::guided_tour(index = tourr::holes), max_bases = 25)
holes_basis <-
  matrix(as.numeric(holes_tour[, , dim(holes_tour)[3]]), ncol = 2)
```


```{r}
tars1 <-
  data_proj(
    data = data,
    basis = holes_basis,
    manip_var = "tars1",
    manip = "radial",
    to = 1.57
  )
tars2 <-
  data_proj(
    data = data,
    basis = holes_basis,
    manip_var = "tars2",
    manip = "radial",
    to = 1.41
  )
head <-
  data_proj(
    data = data,
    basis = holes_basis,
    manip_var = "head",
    manip = "radial",
    from = 0,
    to = 1.26
  )
aede1 <-
  data_proj(
    data = data,
    basis = holes_basis,
    manip_var = "aede1",
    manip = "radial",
    to = 1.41
  )
aede2 <-
  data_proj(
    data = data,
    basis = holes_basis,
    manip_var = "aede2",
    manip = "radial",
    to = 1.41
  )
aede3 <-
  data_proj(
    data = data,
    basis = holes_basis,
    manip_var = "aede3",
    manip = "radial",
    #default
    from = 0,
    #default
    to = 1.73
  )
```


```{r}
#slideshow(tars1, col = flea[, 7]) # groups overlap when removed
#slideshow(aede2, col = flea[, 7]) # groups overlap when removed
#slideshow(tars2, col = flea[, 7]) # 2 groups overlap when removed
#slideshow(head, col = flea[, 7])  # groups still separate when removed
#slideshow(aede1, col = flea[, 7]) # groups still separate when removed
#slideshow(aede3, col = flea[, 7]) # groups still separate when removed
```



# Summary

[RECAP WHAT PKG HELPS US DO, nanier for example:]
The tools in `naniar` help us identify where missingness is, while maintaining a tidy workflow. We care about these mechanisms or these patterns because they can help us understand potential mechanisms, such as equipment failures, and then identify possible solutions based upon this evidence.

# Future development

[further integration with tourr needed?]

# Thank you

Formost, thanks to Di Cook for direction, inspiration, and the ground work underpinning this work. Her ability for conceptualizing higher dimensions and visualizing data in general is unparallel.
Thanks to Ursla Laa for use cases and prompts to keep me focused.

# References
<!-- Monash prefers APA -->
<!-- citation(package = "tourr") -->
<!-- citation(package = "GGally") -->

- Cook, D., & Buja, A. (1997). Manual Controls for High-Dimensional Data Projections. Journal of Computational and Graphical Statistics, 6(4), 464–480. https://doi.org/10.2307/1390747
- Wickham, H., Cook, D., & Hofmann, H. (2015). Visualizing statistical models: Removing the blindfold: Visualizing Statistical Models. Statistical Analysis and Data Mining: The ASA Data Science Journal, 8(4), 203–225. https://doi.org/10.1002/sam.11271
- Dianne Cook and Hadley Wickham (NA). tourr: Implement Tour Methods in R Code. Rpackage version 0.5.5.9000. https://github.com/ggobi/tourr
- Barret Schloerke, Jason Crowley, Di Cook, Francois Briatte, Moritz Marbach,
Edwin Thoen, Amos Elberg and Joseph Larmarange (2017). GGally: Extension to
'ggplot2'. R package version 1.3.2. https://CRAN.R-project.org/package=GGally
- Asimov. et al. (1985)


